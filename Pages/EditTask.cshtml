@page "{id:int}"
@model TaskRoute.Pages.EditTaskModel
@using System.Globalization

@{
    ViewData["Title"] = "Modifica Commissione";
}

@section Styles {
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        main {
            flex: 1;
        }

        #map {
            height: 400px;
            border-radius: 8px;
            position: relative;
            z-index: 1;
        }

        #suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        footer {
            background: #f8f9fa;
            padding: 1rem;
            text-align: center;
        }
    </style>
}

<main class="container mt-4 position-relative">
    <h1 class="mb-4">Modifica Commissione</h1>

    <form method="post">
        <input asp-for="Commission.Id" type="hidden" />

        <div class="mb-3">
            <label asp-for="Commission.Title" class="form-label">Titolo</label>
            <input asp-for="Commission.Title" class="form-control" required />
            <span asp-validation-for="Commission.Title" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Commission.Description" class="form-label">Descrizione</label>
            <textarea asp-for="Commission.Description" class="form-control" rows="3"></textarea>
            <span asp-validation-for="Commission.Description" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Commission.DueDate" class="form-label">Data di scadenza</label>
            <input asp-for="Commission.DueDate" class="form-control" type="date" required />
            <span asp-validation-for="Commission.DueDate" class="text-danger"></span>
        </div>

        <div class="form-check mb-3">
            <input asp-for="Commission.IsCompleted" class="form-check-input" />
            <label asp-for="Commission.IsCompleted" class="form-check-label">Completata</label>
        </div>

        <div class="mb-3 position-relative">
            <label for="addressInput" class="form-label">Indirizzo</label>
            <input id="addressInput" name="searchAddress" class="form-control"
                   placeholder="Digita un indirizzo o clicca sulla mappa" autocomplete="off" />
            <div id="suggestions" class="list-group"></div>
        </div>

        <div id="map" class="mb-4"></div>

        <input type="hidden" id="LocationName" name="LocationName" />
        <input type="hidden" id="LocationAddress" name="LocationAddress" />
        <input type="hidden" id="City" name="City" />
        <input type="hidden" id="PostalCode" name="PostalCode" />
        <input type="hidden" id="Country" name="Country" />
        <input type="hidden" id="Latitude" name="Latitude" />
        <input type="hidden" id="Longitude" name="Longitude" />

        <button type="submit" class="btn btn-primary">Salva</button>
        <a asp-page="./TaskList" class="btn btn-secondary">Annulla</a>
    </form>
</main>

<footer>
    © 2025 - TaskRoute
</footer>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var map = L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            var markerLayer = L.layerGroup().addTo(map);

            function setLocation(latlng, label, details) {
                markerLayer.clearLayers();
                L.marker(latlng).addTo(markerLayer).bindPopup(label).openPopup();
                map.setView(latlng, 15);
                document.getElementById('LocationName').value = details.name || label;
                document.getElementById('LocationAddress').value = details.address || label;
                document.getElementById('City').value = details.city || '';
                document.getElementById('PostalCode').value = details.postcode || '';
                document.getElementById('Country').value = details.country || '';
                document.getElementById('Latitude').value = latlng.lat;
                document.getElementById('Longitude').value = latlng.lng;
                document.getElementById('addressInput').value = label;
            }

        @* Centro iniziale come prima… *@
        @if (Model.Commission.LocationId.HasValue)
        {
            <text>
                        setLocation(
                        L.latLng(@Model.Commission.Location.Latitude.ToString(CultureInfo.InvariantCulture),
                @Model.Commission.Location.Longitude.ToString(CultureInfo.InvariantCulture)),
                        "@Model.Commission.Location.Name",
                        {
                            name: "@Model.Commission.Location.Name",
                        address: "@Model.Commission.Location.Address",
                        city: "@Model.Commission.Location.City",
                        postcode: "@Model.Commission.Location.PostalCode",
                        country: "@Model.Commission.Location.Country"
                            }
                        );
            </text>
        }
        else
        {
            <text>
                        map.on('locationfound', e => setLocation(e.latlng, "Sei qui", { }));
                        map.on('locationerror', () => {
                            var milano = L.latLng(45.4642, 9.19);
                        setLocation(milano, "Milano, Italia", {name: "Milano" });
                        });
                        map.locate({setView: false, maxZoom: 15, timeout: 10000 });
            </text>
        }

                // Typeahead e ricerca Nominatim (come in AddTask)…

                // --- NUOVO: click sulla mappa e reverse-geocoding ---
                map.on('click', function (e) {
                    var url = "https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1"
                        + "&lat=" + e.latlng.lat + "&lon=" + e.latlng.lng;
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            var addr = data.display_name;
                            var ad = data.address || {};
                            var det = {
                                name: addr,
                                address: addr,
                                city: ad.city || ad.town || ad.village || "",
                                postcode: ad.postcode || "",
                                country: ad.country || ""
                            };
                            setLocation(e.latlng, addr, det);
                        })
                        .catch(console.error);
                });
        });
    </script>
}
